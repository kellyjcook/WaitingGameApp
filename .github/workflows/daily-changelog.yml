name: Daily Changelog Email

on:
  schedule:
    # Runs every day at 14:00 UTC (8 AM CST / 9 AM CDT)
    - cron: '0 14 * * *'
  workflow_dispatch: # Allow manual trigger for testing

jobs:
  send-changelog:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Full history needed for git log

      - name: Check for recent changes
        id: changes
        run: |
          # Get commits from the last 24 hours
          SINCE=$(date -u -d '24 hours ago' '+%Y-%m-%dT%H:%M:%SZ')
          COMMITS=$(git log --since="$SINCE" --pretty=format:'- %s (%h by %an)' --no-merges 2>/dev/null || echo "")

          if [ -z "$COMMITS" ]; then
            echo "No commits in the last 24 hours. Skipping email."
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT

            # Build the email body
            TODAY=$(date -u '+%B %d, %Y')
            FILES_CHANGED=$(git log --since="$SINCE" --pretty=format:'' --name-only --no-merges | sort -u | grep -v '^$' || echo "None")
            COMMIT_COUNT=$(git log --since="$SINCE" --oneline --no-merges | wc -l | tr -d ' ')

            # Build email body using printf (avoids heredoc indentation issues in YAML)
            {
              printf "The Waiting Game — Daily Change Report for %s\n\n" "$TODAY"
              printf "%s change(s) deployed in the last 24 hours:\n\n" "$COMMIT_COUNT"
              printf "%s\n\n" "$COMMITS"
              printf "Files affected:\n%s\n\n" "$FILES_CHANGED"
              printf "—\n"
              printf "This is an automated notification from The Waiting Game CI/CD pipeline.\n"
              printf "Repository: https://github.com/kellyjcook/WaitingGameApp\n"
            } > /tmp/email_body.txt
          fi

      - name: Send email notification
        if: steps.changes.outputs.has_changes == 'true'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: mail.dreamhost.com
          server_port: 465
          secure: true
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "The Waiting Game — Changes Deployed (${{ github.run_id }})"
          to: ${{ secrets.NOTIFY_EMAIL }}
          from: The Waiting Game <admin@waitinggameapp.com>
          body: file:///tmp/email_body.txt
